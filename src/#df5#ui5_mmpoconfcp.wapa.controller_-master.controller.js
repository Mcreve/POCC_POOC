sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/Filter","com/delaware/df5-mm-po-confirm-cp/model/formatter","com/delaware/df5-mm-po-confirm-cp/model/GenericElements","sap/m/MessageBox"],function(e,t,r,i,o){"use strict";return e.extend("com.dela+
ware.df5-mm-po-confirm-cp.controller.Master",{oFormatter:r,onInit:function(){this.getView().getModel("TempModel").setProperty("/Locations",[]);this.getView().getModel("TempModel").setProperty("/Prices",[]);this.getView().getModel("TempModel").setProperty+
("/OriginalValues",[])},onStoreLocChange:function(e){let r=e.getSource(),o=r.getValue();let a=false;if(o.length<4){i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),this.getView().getModel("i18n").getResourceBundle().getTe+
xt("InvalidLgortLength"),"OK","Error");e.getSource().setValue(e.getSource().getBindingContext().getObject().StorageLocation)}else{let e=r.getBindingContext().getObject();let n=[];let s=[];s.push(new t({filters:[new sap.ui.model.Filter("Plant",sap.ui.mode+
l.FilterOperator.EQ,e.Plant),new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,e.Material)],and:true}));let l=this.getView().getModel("TempModel").getProperty("/Locations");let g=this.getView().getModel("TempModel").getProperty("/OriginalV+
alues");let u=`S${e.PurchaseOrder}${e.PurchaseOrderLine}`;if(g.length>0){g.forEach(e=>{if(e.PO===u&&e.SLoc===o){a=true}})}else{g.push({PO:u,SLoc:e.StorageLocation})}if(!a){g.push({PO:u,SLoc:e.StorageLocation})}n.push(new t({filters:[new sap.ui.model.Filt+
er("PurchaseOrder",sap.ui.model.FilterOperator.EQ,e.PurchaseOrder),new sap.ui.model.Filter("PurchaseOrderLine",sap.ui.model.FilterOperator.EQ,e.PurchaseOrderLine)],and:true}));this.getData("/xDF5xC_PRODUCTSTORAGELOC_VH",s).then(e=>{let t=[];e.results.for+
Each(e=>{t.push(e.StorageLocation)});if(t.includes(o)){return this.getData("/xDF5xC_POCONF_LIST",n)}else{r.setValue(r.getBindingContext().getObject().StorageLocation);throw new Error(this.getView().getModel("i18n").getResourceBundle().getText("StorageLoc+
NotCorrect"))}}).then(e=>{e.results.forEach(e=>{this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/StorageLocation"+
,o);if(a){this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/TempStoreLoc","None")}else{this.getView().getModel().s+
etProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/TempStoreLoc","Warning")}if(!l.includes(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrd+
er}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`)){l.push(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}+
')`)}});this.getView().getModel("TempModel").setProperty("/Locations",l);this.getView().getModel().setProperty(r.getBindingContext().getPath()+"/Changed","X");this.getView().getModel("GlobalModel").setProperty(`/S${r.getBindingContext().getObject().Purch+
aseOrder}${r.getBindingContext().getObject().PurchaseOrderLine}`,o)}).catch(e=>{if(typeof e==="object"){i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),e.message,"OK","Error")}else{i.showDialog(this.getView().getModel("i+
18n").getResourceBundle().getText("Error"),e,"OK","Error")}})}},handleValueHelp:function(e){let r=e.getParameter("suggestValue");if(!this._valueHelpDialog){this._valueHelpDialog=sap.ui.xmlfragment("com.delaware.df5-mm-po-confirm-cp.view.Dialog",this);thi+
s.getView().addDependent(this._valueHelpDialog)}let i=[];let o=e.getSource().getBindingContext().getObject();this.getView().getModel("GlobalModel").setProperty("/TempSource",e.getSource());i.push(new t({filters:[new sap.ui.model.Filter("Plant",sap.ui.mod+
el.FilterOperator.EQ,o.Plant),new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,o.Material)],and:true}));if(r){i.push(new t("StorageLocation",sap.ui.model.FilterOperator.Contains,r))}this._valueHelpDialog.getBinding("items").filter(i);this+
._valueHelpDialog.open()},_handleValueHelpSearch:function(e){let r=e.getParameter("value");let i=e.getSource().getBinding("items").sFilterParams.substring(24,28);let o=e.getSource().getBinding("items").sFilterParams.substring(58,e.getSource().getBinding(+
"items").sFilterParams.indexOf("%",58));let a=[];a.push(new t({filters:[new t("Plant",sap.ui.model.FilterOperator.EQ,i),new t("Product",sap.ui.model.FilterOperator.EQ,o),new t("StorageLocation",sap.ui.model.FilterOperator.Contains,r)],and:true}));e.getSo+
urce().getBinding("items").filter(a)},_handleValueHelpClose:function(e){let r=[];let o=e.getParameter("selectedItem");let a=this.getView().getModel("GlobalModel").getProperty("/TempSource");let n=a.getBindingContext().getObject();r.push(new t({filters:[n+
ew sap.ui.model.Filter("PurchaseOrder",sap.ui.model.FilterOperator.EQ,n.PurchaseOrder),new sap.ui.model.Filter("PurchaseOrderLine",sap.ui.model.FilterOperator.EQ,n.PurchaseOrderLine)],and:true}));if(o){let t=this.getView().getModel("GlobalModel").getProp+
erty("/TempSource");let o=false;let a=e.getParameter("selectedItem").getTitle();let s=this.getView().getModel("TempModel").getProperty("/Locations");let l=this.getView().getModel("TempModel").getProperty("/OriginalValues");let g=`S${n.PurchaseOrder}${n.P+
urchaseOrderLine}`;if(l.length>0){l.forEach(e=>{if(e.PO===g&&e.SLoc===a){o=true}})}else{l.push({PO:g,SLoc:n.StorageLocation})}if(!o){l.push({PO:g,SLoc:n.StorageLocation})}this.getData("/xDF5xC_POCONF_LIST",r).then(e=>{e.results.forEach(e=>{this.getView()+
.getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/StorageLocation",a);if(o){this.getView().getModel().setProperty(`/xDF5xC_POCON+
F_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/TempStoreLoc","None")}else{this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrd+
er}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/TempStoreLoc","Warning")}if(!s.includes(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfir+
mation='${e.SupplierConfirmation}')`)){s.push(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`)}});this.getView().getModel("TempModel").setProperty("/Loc+
ations",s);this.getView().getModel().setProperty(t.getBindingContext().getPath()+"/Changed","X");this.getView().getModel("GlobalModel").setProperty(`/S${t.getBindingContext().getObject().PurchaseOrder}${t.getBindingContext().getObject().PurchaseOrderLine+
}`,a)}).catch(e=>{if(typeof e==="object"){i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),e.message,"OK","Error")}else{i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),e,"OK","Error")}})}+
},onPriceChange:function(e){let r=e.getSource(),o=r.getValue();let a=false;let n=r.getBindingContext().getObject();let s=[];let l=o.indexOf(",");let g=o.indexOf(".");if(l<g){o=parseFloat(o.replace(",","")).toFixed(2)}else if(g<l){o=parseFloat(o.replace("+
.","").replace(",",".")).toFixed(2)}let u=this.getView().getModel("TempModel").getProperty("/Prices");let d=this.getView().getModel("TempModel").getProperty("/OriginalValues");let c=`P${n.PurchaseOrder}${n.PurchaseOrderLine}`;if(d.length>0){d.forEach(e=>+
{if(e.PO===c&&e.Price===o){a=true}})}else{d.push({PO:c,Price:n.NetPrice})}if(!a){d.push({PO:c,Price:n.NetPrice})}s.push(new t({filters:[new sap.ui.model.Filter("PurchaseOrder",sap.ui.model.FilterOperator.EQ,n.PurchaseOrder),new sap.ui.model.Filter("Purch+
aseOrderLine",sap.ui.model.FilterOperator.EQ,n.PurchaseOrderLine)],and:true}));this.getData("/xDF5xC_POCONF_LIST",s).then(e=>{e.results.forEach(e=>{this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrde+
rLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/NetPrice",o);if(a){this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfir+
mation='${e.SupplierConfirmation}')`+"/TempNetPr","None")}else{this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/T+
empNetPr","Warning")}if(!u.includes(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`)){u.push(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',Pur+
chaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`)}});this.getView().getModel("TempModel").setProperty("/Prices",u);this.getView().getModel().setProperty(r.getBindingContext().getPath()+"/Changed","X");this.getVie+
w().getModel("GlobalModel").setProperty(`/P${r.getBindingContext().getObject().PurchaseOrder}${r.getBindingContext().getObject().PurchaseOrderLine}`,o)}).catch(e=>{i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),e,"OK","+
Error")})},onDelDateChange:function(e){let t=e.getSource(),o=t.getValue();let a=this.oFormatter.formatDate(o);let n=e.getParameter("valid");if(a!=="Invalid Date"&&n){this.getView().getModel().setProperty(t.getBindingContext().getPath()+"/ConfirmedDelDate+
",a)}else{let e=r.formatSAPDate(this.getView().getModel().getProperty(t.getBindingContext().getPath()+"/ConfirmedDelDate"));t.setValue(e);i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),this.getView().getModel("i18n").ge+
tResourceBundle().getText("InvalidDate"),"OK","Error")}},onReferenceChange:function(e){let t=e.getSource(),r=t.getValue();this.getView().getModel().setProperty(t.getBindingContext().getPath()+"/Reference",r)},onSave:function(e){this._aPO=[];let t=e.getSo+
urce().getParent().getParent().getSelectedIndices();this._oTable=e.getSource().getParent().getParent();if(t.length===0){i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),this.getView().getModel("i18n").getResourceBundle().+
getText("NoItems"),"OK","Error")}else{let r=false;t.forEach(t=>{let i=e.getSource().getParent().getParent().getContextByIndex(t).getObject();if(i.Quantity>i.TotalUnconfirmed){r=true}});if(r){o.warning(this.getView().getModel("i18n").getResourceBundle().g+
etText("WarningOverConfirmation"),{actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK,onClose:e=>{if(e===o.Action.OK){this.handleConfirm(this._oTable)}}})}else{this.handleConfirm(this._oTable)}}},handleConfirm:function(e){let r=[];this._a+
PO=[];let a=e.getSelectedIndices();this._oTable=e;this.getView().setBusy(true);a.forEach(t=>{let i=e.getContextByIndex(t).getObject();r.push(i);this._aPO.push({PurchaseOrder:i.PurchaseOrder,PurchaseOrderLine:i.PurchaseOrderLine})});let n=[];let s=[];let +
l=[];let g;let u;r.forEach(e=>{delete e.TempStoreLoc;delete e.TempNetPr;e.Quantity=e.Quantity.toString();u=e;l.push(new t({filters:[new sap.ui.model.Filter("PurchaseOrder",sap.ui.model.FilterOperator.EQ,e.PurchaseOrder),new sap.ui.model.Filter("PurchaseO+
rderLine",sap.ui.model.FilterOperator.EQ,e.PurchaseOrderLine)],and:true}));if(this.getView().getModel("GlobalModel").getProperty(`/C${e.PurchaseOrder}${e.PurchaseOrderLine}`)||this.getView().getModel("GlobalModel").getProperty(`/S${e.PurchaseOrder}${e.Pu+
rchaseOrderLine}`)||this.getView().getModel("GlobalModel").getProperty(`/P${e.PurchaseOrder}${e.PurchaseOrderLine}`)||e.SupplierConfirmation===""||e.SupplierConfirmation==="0"){n.push(e);this.getView().getModel("GlobalModel").setProperty(`/C${e.PurchaseO+
rder}${e.PurchaseOrderLine}`,true)}else{s.push(e)}g=e.PurchaseOrder});this.getData("/xDF5xC_SUPPLIERCONFIRMATION",l).then(e=>{e.results.forEach(e=>{s.forEach(t=>{let r=this.getView().getModel("GlobalModel").getProperty(`/C${t.PurchaseOrder}${t.PurchaseOr+
derLine}`);if(e.PurchaseOrder===t.PurchaseOrder&&e.PurchaseOrderLine===t.PurchaseOrderLine&&e.SupplierConfirmation===t.SupplierConfirmation){e.Quantity=t.Quantity;e.NetPrice=t.NetPrice;e.ConfirmedDelDate=t.ConfirmedDelDate;e.Reference=t.Reference;e.Stora+
geLocation=t.StorageLocation;if(r!==true){e.Changed=t.Changed;this.getView().getModel("GlobalModel").setProperty(`/C${t.PurchaseOrder}${t.PurchaseOrderLine}`,true)}}});let t={...u};t.Quantity=e.Quantity;t.NetPrice=e.NetPrice;t.ConfirmedDelDate=e.Confirme+
dDelDate;t.Reference=e.Reference;t.StorageLocation=e.StorageLocation;t.PurchaseOrder=e.PurchaseOrder;t.PurchaseOrderLine=e.PurchaseOrderLine;t.SupplierConfirmation=e.SupplierConfirmation;t.Material=e.Material;t.Changed=e.Changed;n.unshift(t)});let t={to_+
ConfLines:[{purchaseorder:g,to_Lines:n,to_Log:[]}]};return this.POSTData(this,"xDF5xC_ACTIONID",t)}).then(e=>{this.getView().getModel("GlobalModel").setData({});let r=[];let a=e.to_ConfLines.results;a.forEach(e=>{e.to_Log.results.forEach(e=>{if(e.ztype==+
="E"||e.ztype==="E"){r.push(e.zmessage)}})});if(r.length>0){let e="";r.forEach(t=>{e=e+`<li>${t}</li>`});o.error(this.getView().getModel("i18n").getResourceBundle().getText("ErrorDuringConfirmation"),{title:this.getView().getModel("i18n").getResourceBund+
le().getText("Error"),id:"messageBoxId1",details:`<ul>\n              ${e}\n              </ul>`});this.getView().getModel().refresh()}else{i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Success"),this.getView().getModel("i18n"+
).getResourceBundle().getText("ConfOk"),"OK","Success");let e=this.getView().getModel("TempModel").getProperty("/Locations");let r=this.getView().getModel("TempModel").getProperty("/Prices");if(e.length>0){e.forEach(e=>{this.getView().getModel().setPrope+
rty(e+"/TempStoreLoc","None")})}if(r.length>0){r.forEach(e=>{this.getView().getModel().setProperty(e+"/TempNetPr","None")})}let o=[];this._aPO.forEach(e=>{o.push(new t({filters:[new sap.ui.model.Filter("PurchaseOrder",sap.ui.model.FilterOperator.EQ,e.Pur+
chaseOrder),new sap.ui.model.Filter("PurchaseOrderLine",sap.ui.model.FilterOperator.EQ,e.PurchaseOrderLine)],and:true}))});this.getData("/xDF5xC_POCONF_LIST",o).then(e=>{e.results.forEach(e=>{this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(Pur+
chaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/Quantity",e.Quantity);this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOr+
derLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/Reference",e.Reference)})});this._oTable.setSelectedIndex(-1);this._oTable.getParent().rebindTable();this.getView().getModel().refresh()}this.getView().getModel("TempMo+
del").setProperty("/Locations",[]);this.getView().getModel("TempModel").setProperty("/Prices",[]);this.getView().getModel("TempModel").setProperty("/OriginalValues",[]);this.getView().setBusy(false)}).catch(e=>{console.log(e);i.showDialog(this.getView().+
getModel("i18n").getResourceBundle().getText("Error"),this.getView().getModel("i18n").getResourceBundle().getText("ErrorDuringConfirmation"),"OK","Error");this.getView().setBusy(false);this.getView().getModel().refresh()})},POSTData:function(e,t,r){retur+
n new Promise(function(i,o){let a="/"+t;let n=e.getView().getModel();n.create(a,r,{success:function(t,r){i(t,r);e.getView().setBusy(false)},error:function(t){o(t);e.getView().setBusy(false)}})})},getData:function(e,t){let r=this.getOwnerComponent().getMo+
del();return new Promise((i,o)=>{r.read(e,{filters:[new sap.ui.model.Filter(t,false)],success:e=>{i(e)},error:e=>{o(e)}})})},onBeforeExport:function(e){let t=e.getParameters("exportSettings");for(let e of t.exportSettings.workbook.columns){if(e.property=+
="ConfirmedDelDate"){e.type="date"}}}})});                                                                                                                                                                                                                     