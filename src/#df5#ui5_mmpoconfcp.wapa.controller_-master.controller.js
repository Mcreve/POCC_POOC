sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/Filter","com/delaware/df5-mm-po-confirm-cp/model/formatter","com/delaware/df5-mm-po-confirm-cp/model/GenericElements","sap/m/MessageBox"],function(e,t,r,i,o){"use strict";return e.extend("com.dela+
ware.df5-mm-po-confirm-cp.controller.Master",{oFormatter:r,onInit:function(){this.getView().getModel("TempModel").setProperty("/Locations",[]);this.getView().getModel("TempModel").setProperty("/Prices",[]);this.getView().getModel("TempModel").setProperty+
("/OriginalValues",[])},onStoreLocChange:function(e){let r=e.getSource(),o=r.getValue();let a=false;if(o.length<4){i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),this.getView().getModel("i18n").getResourceBundle().getTe+
xt("InvalidLgortLength"),"OK","Error");e.getSource().setValue(e.getSource().getBindingContext().getObject().StorageLocation)}else{let e=r.getBindingContext().getObject();let s=[];let n=[];n.push(new t({filters:[new sap.ui.model.Filter("Plant",sap.ui.mode+
l.FilterOperator.EQ,e.Plant),new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,e.Material)],and:true}));let l=this.getView().getModel("TempModel").getProperty("/Locations");let g=this.getView().getModel("TempModel").getProperty("/OriginalV+
alues");let u=`S${e.PurchaseOrder}${e.PurchaseOrderLine}`;if(g.length>0){g.forEach(e=>{if(e.PO===u&&e.SLoc===o){a=true}})}else{g.push({PO:u,SLoc:e.StorageLocation})}if(!a){g.push({PO:u,SLoc:e.StorageLocation})}s.push(new t({filters:[new sap.ui.model.Filt+
er("PurchaseOrder",sap.ui.model.FilterOperator.EQ,e.PurchaseOrder),new sap.ui.model.Filter("PurchaseOrderLine",sap.ui.model.FilterOperator.EQ,e.PurchaseOrderLine)],and:true}));this.getData("/xDF5xC_PRODUCTSTORAGELOC_VH",n).then(e=>{let t=[];e.results.for+
Each(e=>{t.push(e.StorageLocation)});if(t.includes(o)){return this.getData("/xDF5xC_POCONF_LIST",s)}else{r.setValue(r.getBindingContext().getObject().StorageLocation);throw new Error(this.getView().getModel("i18n").getResourceBundle().getText("StorageLoc+
NotCorrect"))}}).then(e=>{e.results.forEach(e=>{this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/StorageLocation"+
,o);if(a){this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/TempStoreLoc","None")}else{this.getView().getModel().s+
etProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/TempStoreLoc","Warning")}if(!l.includes(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrd+
er}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`)){l.push(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}+
')`)}});this.getView().getModel("TempModel").setProperty("/Locations",l);this.getView().getModel().setProperty(r.getBindingContext().getPath()+"/Changed","X");this.getView().getModel("GlobalModel").setProperty(`/S${r.getBindingContext().getObject().Purch+
aseOrder}${r.getBindingContext().getObject().PurchaseOrderLine}`,o)}).catch(e=>{if(typeof e==="object"){i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),e.message,"OK","Error")}else{i.showDialog(this.getView().getModel("i+
18n").getResourceBundle().getText("Error"),e,"OK","Error")}})}},handleValueHelp:function(e){let r=e.getParameter("suggestValue");if(!this._valueHelpDialog){this._valueHelpDialog=sap.ui.xmlfragment("com.delaware.df5-mm-po-confirm-cp.view.Dialog",this);thi+
s.getView().addDependent(this._valueHelpDialog)}let i=[];let o=e.getSource().getBindingContext().getObject();this.getView().getModel("GlobalModel").setProperty("/TempSource",e.getSource());i.push(new t({filters:[new sap.ui.model.Filter("Plant",sap.ui.mod+
el.FilterOperator.EQ,o.Plant),new sap.ui.model.Filter("Product",sap.ui.model.FilterOperator.EQ,o.Material)],and:true}));if(r){i.push(new t("StorageLocation",sap.ui.model.FilterOperator.Contains,r))}this._valueHelpDialog.getBinding("items").filter(i);this+
._valueHelpDialog.open()},_handleValueHelpSearch:function(e){let r=e.getParameter("value");let i=e.getSource().getBinding("items").sFilterParams.substring(24,28);let o=e.getSource().getBinding("items").sFilterParams.substring(58,e.getSource().getBinding(+
"items").sFilterParams.indexOf("%",58));let a=[];a.push(new t({filters:[new t("Plant",sap.ui.model.FilterOperator.EQ,i),new t("Product",sap.ui.model.FilterOperator.EQ,o),new t("StorageLocation",sap.ui.model.FilterOperator.Contains,r)],and:true}));e.getSo+
urce().getBinding("items").filter(a)},_handleValueHelpClose:function(e){let r=[];let o=e.getParameter("selectedItem");let a=this.getView().getModel("GlobalModel").getProperty("/TempSource");let s=a.getBindingContext().getObject();r.push(new t({filters:[n+
ew sap.ui.model.Filter("PurchaseOrder",sap.ui.model.FilterOperator.EQ,s.PurchaseOrder),new sap.ui.model.Filter("PurchaseOrderLine",sap.ui.model.FilterOperator.EQ,s.PurchaseOrderLine)],and:true}));if(o){let t=this.getView().getModel("GlobalModel").getProp+
erty("/TempSource");let o=false;let a=e.getParameter("selectedItem").getTitle();let n=this.getView().getModel("TempModel").getProperty("/Locations");let l=this.getView().getModel("TempModel").getProperty("/OriginalValues");let g=`S${s.PurchaseOrder}${s.P+
urchaseOrderLine}`;if(l.length>0){l.forEach(e=>{if(e.PO===g&&e.SLoc===a){o=true}})}else{l.push({PO:g,SLoc:s.StorageLocation})}if(!o){l.push({PO:g,SLoc:s.StorageLocation})}this.getData("/xDF5xC_POCONF_LIST",r).then(e=>{e.results.forEach(e=>{this.getView()+
.getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/StorageLocation",a);if(o){this.getView().getModel().setProperty(`/xDF5xC_POCON+
F_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/TempStoreLoc","None")}else{this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrd+
er}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/TempStoreLoc","Warning")}if(!n.includes(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfir+
mation='${e.SupplierConfirmation}')`)){n.push(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`)}});this.getView().getModel("TempModel").setProperty("/Loc+
ations",n);this.getView().getModel().setProperty(t.getBindingContext().getPath()+"/Changed","X");this.getView().getModel("GlobalModel").setProperty(`/S${t.getBindingContext().getObject().PurchaseOrder}${t.getBindingContext().getObject().PurchaseOrderLine+
}`,a)}).catch(e=>{if(typeof e==="object"){i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),e.message,"OK","Error")}else{i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),e,"OK","Error")}})}+
},onPriceChange:function(e){let r=e.getSource(),o=r.getValue();let a=false;let s=r.getBindingContext().getObject();let n=[];o=parseFloat(o.replace(",",".")).toFixed(2);let l=this.getView().getModel("TempModel").getProperty("/Prices");let g=this.getView()+
.getModel("TempModel").getProperty("/OriginalValues");let u=`P${s.PurchaseOrder}${s.PurchaseOrderLine}`;if(g.length>0){g.forEach(e=>{if(e.PO===u&&e.Price===o){a=true}})}else{g.push({PO:u,Price:s.NetPrice})}if(!a){g.push({PO:u,Price:s.NetPrice})}n.push(ne+
w t({filters:[new sap.ui.model.Filter("PurchaseOrder",sap.ui.model.FilterOperator.EQ,s.PurchaseOrder),new sap.ui.model.Filter("PurchaseOrderLine",sap.ui.model.FilterOperator.EQ,s.PurchaseOrderLine)],and:true}));this.getData("/xDF5xC_POCONF_LIST",n).then(+
e=>{e.results.forEach(e=>{this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/NetPrice",o);if(a){this.getView().getM+
odel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/TempNetPr","None")}else{this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(+
PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/TempNetPr","Warning")}if(!l.includes(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.Purchas+
eOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`)){l.push(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`)}});this.getView().getModel("Te+
mpModel").setProperty("/Prices",l);this.getView().getModel().setProperty(r.getBindingContext().getPath()+"/Changed","X");this.getView().getModel("GlobalModel").setProperty(`/P${r.getBindingContext().getObject().PurchaseOrder}${r.getBindingContext().getOb+
ject().PurchaseOrderLine}`,o)}).catch(e=>{i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),e,"OK","Error")})},onDelDateChange:function(e){let t=e.getSource(),o=t.getValue();let a=this.oFormatter.formatDate(o);let s=e.getP+
arameter("valid");if(a!=="Invalid Date"&&s){this.getView().getModel().setProperty(t.getBindingContext().getPath()+"/ConfirmedDelDate",a)}else{let e=r.formatSAPDate(this.getView().getModel().getProperty(t.getBindingContext().getPath()+"/ConfirmedDelDate")+
);t.setValue(e);i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),this.getView().getModel("i18n").getResourceBundle().getText("InvalidDate"),"OK","Error")}},onReferenceChange:function(e){let t=e.getSource(),r=t.getValue();+
this.getView().getModel().setProperty(t.getBindingContext().getPath()+"/Reference",r)},handleConfirm:function(e){let r=[];this._aPO=[];let a=e.getSource().getParent().getParent().getSelectedIndices();this._oTable=e.getSource().getParent().getParent();if(+
a.length===0){i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),this.getView().getModel("i18n").getResourceBundle().getText("NoItems"),"OK","Error")}else{this.getView().setBusy(true);a.forEach(t=>{let i=e.getSource().getPa+
rent().getParent().getContextByIndex(t).getObject();r.push(i);this._aPO.push({PurchaseOrder:i.PurchaseOrder,PurchaseOrderLine:i.PurchaseOrderLine})});let s=[];let n=[];let l=[];let g;let u;r.forEach(e=>{delete e.TempStoreLoc;delete e.TempNetPr;e.Quantity+
=e.Quantity.toString();u=e;l.push(new t({filters:[new sap.ui.model.Filter("PurchaseOrder",sap.ui.model.FilterOperator.EQ,e.PurchaseOrder),new sap.ui.model.Filter("PurchaseOrderLine",sap.ui.model.FilterOperator.EQ,e.PurchaseOrderLine)],and:true}));if(e.Su+
pplierConfirmation===""||e.SupplierConfirmation==="0"){s.push(e);this.getView().getModel("GlobalModel").setProperty(`/C${e.PurchaseOrder}${e.PurchaseOrderLine}`,true)}else{n.push(e)}g=e.PurchaseOrder});this.getData("/xDF5xC_SUPPLIERCONFIRMATION",l).then(+
e=>{e.results.forEach(e=>{n.forEach(t=>{let r=this.getView().getModel("GlobalModel").getProperty(`/C${t.PurchaseOrder}${t.PurchaseOrderLine}`);if(e.PurchaseOrder===t.PurchaseOrder&&e.PurchaseOrderLine===t.PurchaseOrderLine&&e.SupplierConfirmation===t.Sup+
plierConfirmation){e.Quantity=t.Quantity;e.NetPrice=t.NetPrice;e.ConfirmedDelDate=t.ConfirmedDelDate;e.Reference=t.Reference;e.StorageLocation=t.StorageLocation;if(r!==true){e.Changed=t.Changed;this.getView().getModel("GlobalModel").setProperty(`/C${t.Pu+
rchaseOrder}${t.PurchaseOrderLine}`,true)}}});let t={...u};t.Quantity=e.Quantity;t.NetPrice=e.NetPrice;t.ConfirmedDelDate=e.ConfirmedDelDate;t.Reference=e.Reference;t.StorageLocation=e.StorageLocation;t.PurchaseOrder=e.PurchaseOrder;t.PurchaseOrderLine=e+
.PurchaseOrderLine;t.SupplierConfirmation=e.SupplierConfirmation;t.Material=e.Material;t.Changed=e.Changed;s.unshift(t)});let t={to_ConfLines:[{purchaseorder:g,to_Lines:s,to_Log:[]}]};return this.POSTData(this,"xDF5xC_ACTIONID",t)}).then(e=>{let r=[];let+
 a=e.to_ConfLines.results;a.forEach(e=>{e.to_Log.results.forEach(e=>{if(e.ztype==="E"||e.ztype==="E"){r.push(e.zmessage)}})});if(r.length>0){let e="";r.forEach(t=>{e=e+`<li>${t}</li>`});o.error(this.getView().getModel("i18n").getResourceBundle().getText(+
"ErrorDuringConfirmation"),{title:this.getView().getModel("i18n").getResourceBundle().getText("Error"),id:"messageBoxId1",details:`<ul>\n\t\t\t\t\t\t\t\t${e}\n\t\t\t\t\t\t\t\t</ul>`});this.getView().getModel().refresh()}else{i.showDialog(this.getView().g+
etModel("i18n").getResourceBundle().getText("Success"),this.getView().getModel("i18n").getResourceBundle().getText("ConfOk"),"OK","Success");let e=this.getView().getModel("TempModel").getProperty("/Locations");let r=this.getView().getModel("TempModel").g+
etProperty("/Prices");if(e.length>0){e.forEach(e=>{this.getView().getModel().setProperty(e+"/TempStoreLoc","None")})}if(r.length>0){r.forEach(e=>{this.getView().getModel().setProperty(e+"/TempNetPr","None")})}this.getView().getModel().refresh();let o=[];+
this._aPO.forEach(e=>{o.push(new t({filters:[new sap.ui.model.Filter("PurchaseOrder",sap.ui.model.FilterOperator.EQ,e.PurchaseOrder),new sap.ui.model.Filter("PurchaseOrderLine",sap.ui.model.FilterOperator.EQ,e.PurchaseOrderLine)],and:true}))});this.getDa+
ta("/xDF5xC_POCONF_LIST",o).then(e=>{e.results.forEach(e=>{this.getView().getModel().setProperty(`/xDF5xC_POCONF_LIST(PurchaseOrder='${e.PurchaseOrder}',PurchaseOrderLine='${e.PurchaseOrderLine}',SupplierConfirmation='${e.SupplierConfirmation}')`+"/Quant+
ity",e.Quantity)})});this._oTable.setSelectedIndex(-1)}this.getView().getModel("TempModel").setProperty("/Locations",[]);this.getView().getModel("TempModel").setProperty("/Prices",[]);this.getView().getModel("TempModel").setProperty("/OriginalValues",[])+
;this.getView().setBusy(false)}).catch(e=>{console.log(e);i.showDialog(this.getView().getModel("i18n").getResourceBundle().getText("Error"),this.getView().getModel("i18n").getResourceBundle().getText("ErrorDuringConfirmation"),"OK","Error");this.getView(+
).setBusy(false);this.getView().getModel().refresh()})}},POSTData:function(e,t,r){return new Promise(function(i,o){let a="/"+t;let s=e.getView().getModel();s.create(a,r,{success:function(t,r){i(t,r);e.getView().setBusy(false)},error:function(t){o(t);e.ge+
tView().setBusy(false)}})})},getData:function(e,t){let r=this.getOwnerComponent().getModel();return new Promise((i,o)=>{r.read(e,{filters:[new sap.ui.model.Filter(t,false)],success:e=>{i(e)},error:e=>{o(e)}})})},onBeforeExport:function(e){let t=e.getPara+
meters("exportSettings");for(let e of t.exportSettings.workbook.columns){if(e.property=="ConfirmedDelDate"){e.type="date"}}}})});                                                                                                                              